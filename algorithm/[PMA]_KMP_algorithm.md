# [패턴매칭 알고리즘 中] KMP 알고리즘



> 배경이해

* 브루드포스 방식으로 패턴매칭[^1]을 수행시, 탐색하다가 일치하지 않는 부분이 나오면 기존의 시작점에 
  `+1`하고 다시 처음부터 탐색을 시작한다.
* 이러한 방식을 개선하고자, 일치하지 않는 부분의 직전인 '일치한 부분'을 이용해서 탐색 범위를 줄이는 방식이 KMP 알고리즘이다.
* 일치했던 부분을 참고하여 (일치할 가능성이 없는 위치를 건너뛰고) 다음번에 탐색해야 하는 위치를 설정하는 것이 KMP 알고리즘이다.

​    



> 기초용어

1. **접미사**와 **접두사**의 개념을 예시를 통해 이해해보자.

* `banana`라는 단어가 있을때 **접두사**는 다음과 같다.
  * `b`
  * `ba`
  * `ban`
  * `bana`
  * `banan`
  * `banana`

* `banana`의 **접미사**는 다음과 같다.
  * `a`
  * `na`
  * `ana`
  * `nana`
  * `anana`
  * `banana`

* 즉, **접미사**는 <u>단어의 첫번째 문자를 시작점으로 하여 뒤로 늘려가는 부분집합</u>을 의미하고, 
  **접두사**는 <u>단어의 마지막 문자를 끝점으로 하여 앞으로 붙여가는 부분집합</u>을 의미한다.

​     



2. **실패함수(failure_function)**

* 함수라고 썼지만 사실 **배열**을 의미한다. (편의상 **실패배열**이라고 부르겠다)

* 일단 실패배열은 **`패턴문자열`**의 길이와 같다.

* 실패배열의 각 인덱스의 값은, **`패턴문자열`**에서 해당 인덱스의 문자와 관련된 정보를 담고 있다.

  * 예를 들어 **`패턴문자열`**이 `"yum"`일 때, 실패배열은 `[y관련정보, u관련정보, m관련정보]`이다.

* ★ **각 문자열 관련 정보**:  각 문자를  포함한 이전의 문자열 중, **접두사와 접미사가 일치하는 최대 길이**

  (다시 말하면, 각 문자를 포함한 이전 문자열 중 **`접두사 == 접미사`**인 부분의 최장 길이를 뜻한다.)    

  

---

##### 	실패함수값이 내포한 의미

​	★ 실패함수값이 내포한 의미는 **해당 위치의 문자에서 실패함수값만큼 뺀 지점부터 다시 해당 문자열을 **
​         **만들 수 있다**는 의미다.      

---

​     

* 예시를 통해 실패 함수를 이해해보자.
  (패턴문자열: 'abaabab')

  | 인덱스번호(i) | 각 문자열 포함 이전문자열 | 실패함수의 값 |
  | :-----------: | :-----------------------: | :-----------: |
  |       0       |             a             |       0       |
  |       1       |            a b            |       0       |
  |       2       |       **a** b **a**       |       1       |
  |       3       |      **a** b a **a**      |       1       |
  |   <u>4</u>    |     **a b **a **a b**     |       2       |
  |       5       |    **a b a** **a b a**    |       3       |
  |       6       |   **a b** a a b **a b**   |       2       |

  * 각 인덱스번호를 기준으로 [:i]에 해당하는 문자열의 접두사와 접미사가 일치하는 최대 길이를 찾는다.
  * 앞서 설명한 [실패함수값이 내포한 의미](#실패함수값이-내포한-의미)를 위의 예시를 통해 설명한다. 
    * 인덱스 4번을 예로들면 실패함수의 값이 2이다. 
    * 이는 **자신을 포함해서 앞으로 2칸 간 위치**부터 시작해 **다시 패턴 문자열을 구성**할 수 있다는 뜻이다. 
    * 이는 4 - 2 + 1 (=`인덱스 값 - 실패함수 값 - 1`) 위치부터 패턴 문자열을 구성할 수 있다는 뜻이다. 
      (+1을 수행한 이유는 자신을 포함하여 2칸만 가야하기 때문이다.)
    * 4-2+1의 값은 3이고 3번 인덱스부터 패턴문자열이 가능한지 살펴보자 
    * (3번 인덱스의 문자는 a , 4번 인덱스의 문자는 b) 'ab'로 시작하면 패턴문자열을 구성할 수 있다.
    * 이는 실패함수의 값이 접두사 (*문자열의 가장 앞부분부터 시작하는 부분문자열*)와 일치하는 
      접미사 (*문자열의 가장 뒷부분을 끝으로 하는 부분문자열*)의 최장길이를 뜻하기에 가능한 것이다. 
      * 즉, (접두사와 일치하는)접미사를 깔고 그 다음부터 새로운 패턴문자열 그릴 수 있다는 것

 

> 기본내용 개요

* KMP 알고리즘의 내용은 크게 2부분으로 구성되어 있다.
* 첫번째는 실패배열을 활용하여 **패턴매칭을 수행하는 부분 (기본내용 _ 1)**이다. 
* 두번째는 패턴문자열을 가지고 **실패배열을 만드는 부분(기본내용 _ 2)**이다.
* 위에서 설명한 순서대로 아래에 세부 설명을 작성하였다. 
  * 순서상으로 보면 실패배열을 만드는 것을 먼저 배우고 패턴매칭을 수행하는 것을 배우는게 맞는 것 같다.
  * 그런데 KMP를 설명하는 대부분의 블로그 글들을 보면 위 순서대로 작성되어 있다.
  * 이유는 잘 모르겠지만 내 느낌으로는 패턴매칭 수행 부분이 이해가 좀 더 쉽기 때문이라고 생각한다.
  * 또한 패턴매칭 수행에서 배운 작동과정이 실패배열을 만드는데 사용된다. 
  * 따라서 쉬운 것을 통해 원리를 이해하고 이를 어려운 것을 이해하는 데 사용하는 것 아닐까 생각한다.

​     



> 기본내용 _ 1 패턴매칭 수행 부분

* 패턴매칭을 수행하기 위해 **탐색 대상이 되는 문자열의 탐색 시작지점을 나타내는 변수(start)**를 생성한다.    

  

* 탐색 대상의 **탐색 영역**(시작점에서 패턴문자열의 길이만큼의 영역)의 각 문자와 **패턴문자열**의 각 문자를 
  비교하기 위한 **포인터 변수(pointer)**를 생성한다. 
  
  * 포인터 변수는 탐색영역의 각 문자와 패턴문자열의 각 문자를 하나씩 비교하기 위한 인덱싱에 사용된다.
  * 탐색영역 인덱싱에는 **start + pointer**로 접근하고, 패턴문자열의 인덱싱에는 **pointer**로 접근한다.    



​	**[패턴 매칭의 종료 조건은]**

* **pointer**가 **패턴문자열의 길이**가 되거나  - - - - - - - - - - - - - - - - - ▷ 0부터 pointer-1까지 탐색완료

* **start**가 **탐색문자열 길이 - 패턴문자열 길이**보다 큰 경우다. - - - ▷ 남은 구간이 패턴 문자열보다 짧음    

  

​	**[패턴 매칭 수행시 현재 비교하는 문자가 일치하는 경우는]**

* **m** 값을 **+1** 해준다.

* 만약 **m**의 값이 **패턴문자열의 길이**와 같은 경우, 패턴매칭을 찾은 것을 뜻한다.

* 따라서 우리가 원하는 작업을 할 수 있다(예시: **start**위치를 저장)    

  

​	**[패턴매칭을 수행하다가 일치하지 않는 부분이 발견되면]** 

* 이는 그 이전까지는 일치했다는 것을 의미한다.
* 만약 그 이전까지 일치했던 부분이 없다면(**pointer**가 **0**이면), **start**를 한칸 옮기고 다시 탐색을 수행한다.    
* 만약 **pointer**가 **0**이 아니라면 (=이전에 일치했던 부분이 있다면) 현재 위치 직전의 실패함수 값을 불러온다.
  * 실패함수 값의 의미는 **해당 위치를 포함하여 실패함수 값만큼 앞으로 간 위치**에서 **새롭게 패턴문자열을 시작할 수 있다는 것**을 의미한다.
  *  따라서 **start**위치를 **start += pointer - 실패함수[pointer-1]** 으로 수정한다.
    * **pointer**: 일치하지 않는 문자가 나온 지점
    * **실패함수[pointer-1]**: (일치했던)직전의 문자열에서 (접두사와 일치하는) 최장 접미사 길이
  * **pointer**위치는 **pointer = 실패함수[pointer-1]** 으로 수정한다.
    * **실패함수[pointer-1]**는 일치한 길이를 뜻한다.
    * **pointer**를 **실패함수[pointer-1]**로 하면 일치한 부분 바로 다음 위치를 가리키게 된다 
      (예시_ 2는 인덱스상 3번째 위치.)     

​      



> 기본내용 _ 2 실패배열 만들기

* 실패 배열의 정의는 다음과 같다.

  * 0번째 인덱스를 제외한 각 인덱스에서 **시작부터 해당 인덱스까지의 부분문자열** 중 **접두사와 접미사가 일치하는 최장 길이**의 배열

* 단순하게 생각하면 각 인덱스의 문자를 순회하며 `접두사 == 접미사`인 최장 길이를 찾는 작업을 통해 실패 배열을 만들 수 있다.(아직 해결 못함)

* 하지만 앞서 배운 KMP 알고리즘의 패턴매칭 방식을 이용하면 더 빠르게 실패배열을 만들 수 있다.

* 실패배열은 패턴문자열을 **탐색대상문자열**이자 **패턴문자열**로 사용해서 만든다.

  * **탐색대상문자열의 포인터가 가리키는 인덱스**는 **실패배열의 인덱스**가 된다.
  * 즉, **탐색대상문자열의 포인터**는 **해당 문자열이 차지하는 부분 문자열의 끝**이다.
  * 이 끝부분과 패턴문자열의 시작부분을 비교하는 것이 바로 **접두사**와 **접미사**를 비교하는 것이 된다.

* 사용할 포인터 변수들

  * 패턴문자열의 포인터(**ppointer**)는 (접미사와 일치하는) 접두사를 가리킬 포인터로 사용

    * ppointer는 접두사를 가리킬 포인터이기에 초기값은 0이다.

  * 탐색대상문자열의 포인터는 begin + ppointer를 사용한다.

    * (접두사가 한칸 늘어나면 접미사도 한칸 늘어나야 한다)
    * begin은 현재 일치한 부분의 시작위치를 의미한다.
    * 실패배열의 0번 인덱스의 값은 항상 0이기에 **begin**은 초기값을 1로 생성한다.

    

  ​     

​	**[종료조건]**

* begin + ppointer가 패턴문자열의 길이와 같아지는 경우 종료한다.
  * begin + ppointer는 탐색대상문자열의 포인터이자, 실패배열의 인덱스를 가리키는 포인터다.
  * 실패배열을 만들 때 탐색대상문자열은 패턴문자열과 같다.
  * 따라서 begin + ppointer가 패턴문자열의 길이가 되었다는 것은 모든 탐색이 끝났다는 것이다.

​     

​	**[일치하는 경우]**

* `ppointer += 1` :  `ppointer`를 +1 증가시킨다 

  * 탐색문자열의 포인터와 패턴문자열의 포인터를 1칸씩 이동한다(접두사와 접미사 길이 늘림)

* `실패배열[begin+ppointer-1] = ppointer` 

  * 방금 `ppointer`를 1 증가시켰기에 -1을 해줘야 이전 위치가 된다.

  * 이전 위치의 실패배열 값을 `ppointer`로 해준다.
    (`ppointer`는 인덱스이기에 실제 길이를 의미하게 하려면 +1을 해줘야 한다.)

    



​	**[일치하지 않는 경우]**

* 만약 ppointer 값이 0이라면 (=그전에 일치한 적이 없는 경우라면)

  * ppointer값은 그대로 두고(접두사 위치 고정), 접미사 위치인 begin만 +1 해준다.

* 만약 ppointer 값이 0이 아니라면(=그전에 일치한 적이 있었다면) 현재 위치 직전의 실패함수 값을 불러온다.

  * begin 값을 begin + (ppointer - 실패배열[ppointer-1])로 해준다.

    ▶ 실패함수 값의 의미는 **해당 위치를 포함하여 실패함수 값만큼 앞으로 간 위치**에서 **새롭게 **
         **패턴문자열을 시작할 수 있다는 것**을 의미한다.

  * ppointer값을 실패배열[ppointer-1]로 해준다.

    ▶ **실패함수[pointer-1]**는 일치한 길이를 뜻한다.

    ▶ **pointer**를 **실패함수[pointer-1]**로 하면 일치한 부분 바로 다음 위치를 가리키게 된다 

​      



> 실제 코드 구현 부분 _ 실패 배열 만들기 & 패턴 매칭 수행하기

```python
# 실패 배열 만들기 

# 패턴문자열(pattern string)
ps = "abaabab"


def making_flist(ps):
    ps_len = len(ps)
    failure_list = [0] * ps_len
    # 포인터 생성
	begin = 1
	p = 0

	# 탐색문자열포인터가 탐색범위를 벗어난 경우(탐색이 모두 끝난 경우) 종료
	while begin+p < ps_len:
        # 접두사와 접미사가 같은 경우 >> 패턴문자열 포인터 1증가 & 실패함수 등록
        if test[begin+p] == ps[p]:
            p += 1
            failure_list[begin+p-1] = p
        # 접두사와 접미사가 다른 경우 
        else:
            # 이전에 같은 것이 없는 경우 >> begin에 +1을 해줘서 접미사 기준점 이동 
            if p == 0:
                begin += 1
    
    		# 이전에 같은 것이 있는 경우 
		    # ▷ 같은 부분부터 다시 (접두사 == 접미사) 확인할 수 있다. 
    		# ▷▷ 접미사 기준점을 현재위치(begin + p)에서 같은 부분(실패배열[p-1]) 만큼 뒤로 이동
		    # ▷▷ 접두사 기준점을 같은 부분 다음 위치(실패배열[p-1])로 옮긴다.
    		else:
		      begin += (p-failure_list[p-1])
		      p = failure_list[p-1]
    return failure_list

print(making_flist(ps))
## 결과값: [0, 0, 1, 1, 2, 3, 2]
```

​     

----

​     

```python
# 패턴 매칭 수행하기 
## 앞에서 작성한 실패함수 생성 함수(making_flist) 사용해서 작성


# target_string
ts = "abaabababc"
ts_len = len(ts)
# pattern_string
ps = "ababab"
ps_len = len(ps)

f_list = making_flist(ps)

start = 0
pointer = 0

while start <= ts_len - ps_len:
  if pointer < ps_len and ts[start+pointer] == ps[pointer]:
    pointer += 1
    if pointer == ps_len:
      print(start)
      break
  else:
    if pointer == 0:
      start += 1
    else:
      start += (pointer - f_list[pointer-1])
      pointer = f_list[pointer-1]

        
## 결과값 3
```





























> 큰 도움이 된 글

1.https://baeharam.github.io/posts/algorithm/kmp/

2.https://bowbowbow.tistory.com/6







[^1]: 패턴매칭의 기본 내용은 [PMA]Pattern_Matching_Algorithms.md문서를 참고한다



